# Agent 阶段性任务（兵种树状图鉴 V1）

## 目标
把现有“平铺兵种图鉴”升级为“树状进化图鉴”：
- 支持基础兵 -> 一阶进化 -> 二阶进化（可分支）
- 图鉴节点可显示解锁状态、可进化状态、当前阶
- 明确展示每个节点的前置节点与解锁条件（X国Y关）

## 一、范围与边界
- 本期只做“兵种树状图鉴 + 进化链路数据化 + 前后端联通”。
- 不重写战斗核心公式；仅保证进化层级和状态在图鉴/接口可用。
- 允许先做单路线+少量分支样例，结构必须支持后续扩展到十几个兵种。

## 二、后端任务

### B1. 新增“兵种进化树配置”表（核心）
新增表：`troop_tree_node_config`
建议字段：
- `node_id` (PK)
- `troop_id`（该节点对应兵种模板）
- `civ`
- `tier`（0/1/2...）
- `branch_code`（主线/分支A/分支B）
- `parent_node_id`（根节点可为空）
- `unlock_civ`
- `unlock_stage_no`
- `evolve_cost_gold`
- `sort_order`
- `display_name`
- `description`

要求：
- 用配置表达树关系，禁止在代码里写死父子关系。
- 支持一个父节点对应多个子节点（分支进化）。

### B2. 扩展玩家进度结构
沿用 `user_troop_progress`，补齐语义：
- `status`：LOCKED/DISCOVERED/UNLOCKED
- `evolution_tier`
- `evolution_unlocked`

要求：
- 进化后正确更新对应兵种节点状态。
- 若走分支，未选择分支的节点保持未进化状态（可见但未激活）。

### B3. 图鉴树接口
新增接口：`GET /troop/codex/tree?userId=xxx&civ=CN`
返回结构必须含：
- 节点信息：`nodeId/troopId/name/tier/branchCode/parentNodeId`
- 状态信息：`locked/discovered/unlocked/evolutionUnlocked/currentTier`
- 条件信息：`unlockCiv/unlockStageNo/unlockHint`
- 展示信息：`icon/type/isElite/baseAtk/baseHp/cost`

要求：
- 一次性返回“树 + 玩家状态”，前端无需二次拼树。
- 排序稳定（按 `tier + sort_order`）。

### B4. 进化接口升级（支持分支）
接口：`POST /troop/evolve?userId=xxx`
请求体建议：
- `fromNodeId`
- `toNodeId`

校验：
- `toNode.parentNodeId == fromNodeId`
- 解锁条件达成
- 金币足够
- 分支冲突规则（同 tier 多分支只能选一）

### B5. 初始化数据
在 `data.sql` 写入：
- 至少 1 棵完整树样例（建议 CN）
- 包含：根节点、二级节点、三级节点、至少一个分支
- 其余国家可先给最小骨架（根 + 1级）

## 三、前端任务

### F1. 新增树状图鉴页（替换/升级现有 `/codex`）
页面目标：
- 横向或纵向树状布局，节点可视化连接线
- 节点状态：已解锁/可进化/未解锁（灰态+锁）
- 点击节点看详情（属性、技能说明、解锁条件）

### F2. 布局与交互要求
必须支持：
- 节点多时可滚动（横向优先）
- 桌面与移动端均可浏览
- 当前选中路径高亮
- 分支节点区分明显（颜色/边框/标签）

### F3. 进化交互
- 对“可进化”节点显示按钮
- 调用 `POST /troop/evolve`
- 成功后局部刷新树，不整页重载

### F4. 与招募页联动
- 招募页使用树状态：
  - 未解锁节点不可招募
  - 已解锁节点可招募
- 解锁提示统一复用 `unlockHint`

## 四、验收标准（DoD）
全部满足才算通过：
1. `/troop/codex/tree` 返回树结构，不是平铺列表。
2. 至少一棵兵种树支持“三级 + 分支”。
3. 图鉴页面可视化展示父子连接关系。
4. 未解锁节点灰态并显示具体关卡条件。
5. 进化接口支持分支选择，错误分支会被拦截。
6. 进化后页面状态实时更新。
7. 招募页与图鉴状态一致，不可绕过。

## 五、交付要求（给项目经理查收）
提交 `agent任务完成表.md` 时必须包含：
- 改动文件清单（后端/前端/SQL）
- 树结构示例截图（至少1张）
- 核心接口请求/响应样例
- 分支进化成功与失败用例各1条
- 已知未完成项（若无写“无”）

## 六、最小自测清单
1. 打开图鉴树，能看到节点连接关系。
2. 锁定节点显示“通关 X 国第 Y 关解锁”。
3. 满足条件后，节点从锁定变可进化。
4. 选择分支A进化成功，分支B被标记为未选择分支。
5. 招募页只允许已解锁节点招募。
